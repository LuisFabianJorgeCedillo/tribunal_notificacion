<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Iniciar sesión · SAGJ</title>
  <link rel="stylesheet" href="styles.css" />
  <!-- Supabase JS Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Configuración de Supabase -->
  <script src="supabase-config.js"></script>
</head>
<body>
  <main class="wrap">
    <section class="card">
      <div class="brand">
        <div class="brand__logo" aria-hidden="true">⚖️</div>
        <h1 class="brand__title">SAGJ</h1>
        <p class="brand__subtitle">Sistema Automatizado de Gestión Judicial</p>
      </div>

   <!-- Navega a tu dashboard al iniciar sesión -->
   <!-- Ahora el formulario envía email y password por POST JSON al webhook local
     http://localhost:5678/webhook-test/iniciosession
     y, en caso de éxito (2xx), redirige al dashboard `5.notificador-dashboard.html`. -->
   <form id="loginForm" class="form" action="5.notificador-dashboard.html" method="get" novalidate>
        <div class="field">
          <label for="email">Correo</label>
          <input id="email" name="email" type="email"
                 placeholder="usuario@dominio.com" autocomplete="username" />
        </div>

        <div class="field">
          <label for="password">Contraseña</label>
          <input id="password" name="password" type="password"
                 placeholder="••••••••" autocomplete="current-password" />
        </div>

        <div class="actions" style="justify-content:flex-end; margin-top: 8px;">
          <a class="link" href="3.recuperar-password.html">¿Olvidaste tu contraseña?</a>
        </div>

        <button class="btn" type="submit" style="margin-top:12px;">Ingresar</button>
        <div id="formMessage" role="status" aria-live="polite" style="margin-top:8px;color:#b00020"></div>
      </form>
      <script>
        (function(){
          // ============================================
          // NO REDIRIGIR AUTOMÁTICAMENTE AL DASHBOARD
          // Mejora de seguridad: Forzar login cada vez
          // ============================================
          
          // Limpiar cualquier sesión existente al cargar el login
          // Esto asegura que el usuario debe hacer login explícitamente
          (async function clearOldSession() {
            try {
              const session = await checkAuth();
              if (session) {
                // Hay una sesión activa, pero estamos en login
                // Esto puede suceder si el usuario navega hacia atrás
                // NO redirigir automáticamente, dejar que inicie sesión
                console.log('ℹ️ Sesión previa detectada - requiere nuevo login');
              }
            } catch (error) {
              console.log('Sin sesión previa');
            }
          })();

          const form = document.getElementById('loginForm');
          const emailInput = document.getElementById('email');
          const passwordInput = document.getElementById('password');
          const msg = document.getElementById('formMessage');
          const submitBtn = form.querySelector('button[type="submit"]');

          function showMessage(text, isError = true){
            msg.style.color = isError ? '#b00020' : '#0a0';
            msg.textContent = text;
          }

          form.addEventListener('submit', async function(e){
            e.preventDefault();
            showMessage('', true);

            const email = (emailInput.value || '').trim();
            const password = (passwordInput.value || '');

            if(!email || !password){
              showMessage('Por favor ingresa correo y contraseña.');
              return;
            }

            // Validar formato de email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
              showMessage('Por favor ingresa un correo válido.');
              return;
            }

            // Deshabilitar envío múltiple
            submitBtn.disabled = true;
            const previousText = submitBtn.textContent;
            submitBtn.textContent = 'Verificando...';

            try{
              // Intentar iniciar sesión con Supabase
              const { data, error } = await supabase.auth.signInWithPassword({
                email: email,
                password: password
              });

              if (error) {
                // Manejar errores específicos
                let errorMessage = 'Error al iniciar sesión.';
                
                if (error.message.includes('Invalid login credentials')) {
                  errorMessage = 'Correo o contraseña incorrectos.';
                } else if (error.message.includes('Email not confirmed')) {
                  errorMessage = 'Por favor confirma tu correo electrónico.';
                } else if (error.message.includes('User not found')) {
                  errorMessage = 'Usuario no encontrado.';
                } else {
                  errorMessage = error.message;
                }
                
                showMessage(errorMessage);
                console.error('❌ Error de autenticación:', error);
                return;
              }

              if (data.session) {
                // Login exitoso
                console.log('✅ Login exitoso');
                showMessage('¡Inicio de sesión exitoso! Redirigiendo...', false);
                
                // Guardar información adicional
                localStorage.setItem('user_email', email);
                
                // IMPORTANTE: initSessionTracking se llama automáticamente
                // por el listener onAuthStateChange en supabase-config.js
                
                // Redirigir al dashboard después de un breve delay
                setTimeout(() => {
                  window.location.href = '5.notificador-dashboard.html';
                }, 800);
              }

            } catch(err) {
              // Error inesperado
              showMessage('Error de conexión. Por favor verifica tu configuración de Supabase.');
              console.error('❌ Error inesperado:', err);
            } finally {
              submitBtn.disabled = false;
              submitBtn.textContent = previousText;
            }
          });
        })();
      </script>
    </section>
  </main>
</body>
</html>
